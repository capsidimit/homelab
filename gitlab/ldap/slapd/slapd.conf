# =============================================================================
# OpenLDAP 2.6.10 Server Configuration (slapd.conf)
# TechNova Corp - Homelab LDAP Server
# Suffix: dc=ldap,dc=example,dc=com
# Created: 2026-01-29
# =============================================================================

# -----------------------------------------------------------------------------
# GLOBAL CONFIGURATION
# -----------------------------------------------------------------------------

# Включение схем (schemas)
include         /etc/openldap/schema/core.schema
include         /etc/openldap/schema/cosine.schema
include         /etc/openldap/schema/inetorgperson.schema
include         /etc/openldap/schema/nis.schema

# PID и args файлы
pidfile         /var/run/openldap/slapd.pid
argsfile        /var/run/openldap/slapd.args

# Загрузка модулей
modulepath      /usr/lib/openldap
moduleload      back_mdb.la
moduleload      memberof.la

# Уровень логирования
# none (0), stats (256), config (64), ACL (128)
loglevel        stats config ACL

# Ограничения
sizelimit       500
timelimit       30

# Таймауты
idletimeout     300
writetimeout    600

# Количество потоков
threads         4

# Требования безопасности (аутентификация для всех операций)
security        simple_bind=128
require         authc

# -----------------------------------------------------------------------------
# TLS/SSL CONFIGURATION
# -----------------------------------------------------------------------------

# Путь к сертификатам
TLSCACertificateFile    /etc/openldap/certs/ca.pem
TLSCertificateFile      /etc/openldap/certs/cert.pem
TLSCertificateKeyFile   /etc/openldap/certs/key.pem

# Проверка клиентских сертификатов
TLSVerifyClient         never

# Минимальная версия TLS
TLSProtocolMin          1.2

# Cipher suites (современные и безопасные)
TLSCipherSuite          HIGH:MEDIUM:+SSLv3

# -----------------------------------------------------------------------------
# DATABASE CONFIGURATION: MDB (Memory-Mapped Database Backend)
# -----------------------------------------------------------------------------

database        mdb

# Суффикс базы данных
suffix          "dc=ldap,dc=example,dc=com"

# Root DN (администратор)
rootdn          "cn=admin,dc=ldap,dc=example,dc=com"

# Root пароль (будет установлен из /run/secrets/ldap_admin_password)
# Временное значение - ЗАМЕНИТЕ ПОСЛЕ ГЕНЕРАЦИИ ХЕША!
# Сгенерировать: slappasswd -s ваш_пароль
# rootpw        {SSHA}хеш_вашего_пароля
# ИЛИ использовать скрипт для автоматической установки (см. ниже)

# Путь к файлам базы данных
directory       /var/lib/openldap

# Максимальный размер базы данных MDB (1GB для homelab)
# Можно увеличить при росте данных: 2GB = 2147483648, 5GB = 5368709120
maxsize         1073741824

# Режим доступа к файлам БД
mode            0600

# -----------------------------------------------------------------------------
# INDICES (индексы для оптимизации поиска)
# -----------------------------------------------------------------------------

# Базовые индексы
index   objectClass                     eq
index   cn,uid                          eq,sub
index   uidNumber,gidNumber             eq
index   member,memberOf                 eq
index   mail                            eq,sub
index   sn,givenName                    eq,sub
index   employeeNumber,employeeType     eq

# Специальные индексы для презентации объектов
index   entryCSN                        eq
index   entryUUID                       eq

# -----------------------------------------------------------------------------
# ACCESS CONTROL LISTS (ACL)
# Правила применяются сверху вниз, первое совпадение останавливает проверку
# -----------------------------------------------------------------------------

# ACL 1: Доступ к паролям
# - Владелец может читать и изменять свой пароль
# - Анонимные пользователи могут аутентифицироваться (auth)
# - Остальным запрещено
access to attrs=userPassword
    by self write
    by anonymous auth
    by * none

# ACL 2: Доступ к атрибуту shadowLastChange (для смены паролей)
access to attrs=shadowLastChange
    by self write
    by * read

# ACL 3: Доступ к пользователям (ou=users)
# - Сервисный аккаунт GitLab: чтение
# - Администратор: полный доступ
# - Владелец: чтение своей записи
# - Остальным запрещено
access to dn.subtree="ou=users,dc=ldap,dc=example,dc=com"
    by dn.exact="uid=gitlab,ou=services,dc=ldap,dc=example,dc=com" read
    by dn.exact="cn=admin,dc=ldap,dc=example,dc=com" write
    by self read
    by * none

# ACL 4: Доступ к группам (ou=groups)
# - Сервисный аккаунт GitLab: чтение
# - Администратор: полный доступ
# - Аутентифицированные пользователи: чтение
# - Остальным запрещено
access to dn.subtree="ou=groups,dc=ldap,dc=example,dc=com"
    by dn.exact="uid=gitlab,ou=services,dc=ldap,dc=example,dc=com" read
    by dn.exact="cn=admin,dc=ldap,dc=example,dc=com" write
    by users read
    by * none

# ACL 5: Доступ к сервисным аккаунтам (ou=services)
# - Только администратор
access to dn.subtree="ou=services,dc=ldap,dc=example,dc=com"
    by dn.exact="cn=admin,dc=ldap,dc=example,dc=com" write
    by * none

# -----------------------------------------------------------------------------
# OVERLAYS (расширения функциональности)
# -----------------------------------------------------------------------------

# Overlay: MemberOf (автоматическое добавление атрибута memberOf)
# Когда пользователь добавляется в группу через атрибут member,
# автоматически создаётся обратная ссылка memberOf у пользователя
overlay         memberof
memberof-group-oc       groupOfNames
memberof-member-ad      member
memberof-memberof-ad    memberOf
memberof-refint         TRUE
memberof-dangling       ignore

# -----------------------------------------------------------------------------
# MONITORING (опционально, для отладки)
# -----------------------------------------------------------------------------

# Раскомментируйте для включения мониторинга
# database        monitor
# access to dn.subtree="cn=monitor"
#     by dn.exact="cn=admin,dc=ldap,dc=example,dc=com" read
#     by * none

# =============================================================================
# END OF CONFIGURATION
# =============================================================================
